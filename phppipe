pipeline {
    agent {
        node {
            label 'ana_sunucu'
        }
    }
    triggers {
        pollSCM '* * * * *'
    }
    stages {
        stage('Static Analysis') {
            parallel {
              stage('CodeSniffer') {
                  steps {
                      sh '''
                        cd myapphp
                        composer require --dev phpstan/phpstan
                        composer require "squizlabs/php_codesniffer=*"
                        vendor/bin/phpcs --standard=phpcs.xml .
                        '''
                  }
              }
              stage('PHP Compatibility Checks') {
                  steps {
                      sh '''
                        cd myapphp
                        composer require --dev phpstan/phpstan
                        composer require "squizlabs/php_codesniffer=*"
                        vendor/bin/phpcs --standard=phpcs-compatibility.xml .
                        '''
                  }
              }
              stage('PHPStan') {
                  steps {
                      sh '''
                        cd myapphp
                        composer require --dev phpstan/phpstan
                        composer require "squizlabs/php_codesniffer=*"
                        vendor/bin/phpstan analyse --error-format=checkstyle --no-progress -n . > build/logs/phpstan.checkstyle.xml
                        '''
                  }
              }
            }
        }
    }
    post {
            always {
                recordIssues([
                    sourceCodeEncoding: 'UTF-8',
                    enabledForFailure: true,
                    aggregatingResults: true,
                    tools: [
                        phpCodeSniffer(id: 'phpcs', name: 'CodeSniffer', pattern: 'build/logs/phpcs.checkstyle.xml', reportEncoding: 'UTF-8'),
                        phpStan(id: 'phpstan', name: 'PHPStan', pattern: 'build/logs/phpstan.checkstyle.xml', reportEncoding: 'UTF-8'),
                        phpCodeSniffer(id: 'phpcompat', name: 'PHP Compatibility', pattern: 'build/logs/phpcs-compat.checkstyle.xml', reportEncoding: 'UTF-8')
                    ]
                ])
            }
        }
}
